# Wundr CI Pipeline - Consolidated
#
# Single canonical CI workflow for the Wundr monorepo.
# Covers: lint, typecheck, per-package test matrix with coverage,
# security audit, license compliance, build validation, and PR status.
#
# Triggers: push to main/develop, pull requests, manual dispatch.

name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  CI: true
  FORCE_COLOR: 1
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

# ---------------------------------------------------------------------------
# Reusable anchors
# ---------------------------------------------------------------------------
# Each job that needs node_modules repeats the same setup steps.
# YAML anchors are not supported in GitHub Actions, so a composite action
# or repetition is required. The steps are kept consistent below.

jobs:
  # ===========================================================================
  # 1. INSTALL -- shared dependency cache for all downstream jobs
  # ===========================================================================
  install:
    name: Install
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

  # ===========================================================================
  # 2. LINT -- ESLint (zero warnings) + Prettier format check
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: ESLint
        run: pnpm turbo lint -- --max-warnings=0

      - name: Prettier format check
        run: pnpm turbo format:check

  # ===========================================================================
  # 3. TYPECHECK -- tsc --noEmit via turbo across all packages
  # ===========================================================================
  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: TypeScript type check
        run: pnpm turbo typecheck

  # ===========================================================================
  # 4. TEST -- per-package matrix with coverage
  # ===========================================================================
  test:
    name: "Test (${{ matrix.package }})"
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          # orchestrator-daemon uses vitest
          - package: orchestrator-daemon
            scope: "@wundr.io/orchestrator-daemon"
            runner: vitest
            test-cmd: "pnpm --filter @wundr.io/orchestrator-daemon run test:ci"
            coverage-dir: "packages/@wundr/orchestrator-daemon/coverage"

          # agent-memory uses jest
          - package: agent-memory
            scope: "@wundr.io/agent-memory"
            runner: jest
            test-cmd: "pnpm --filter @wundr.io/agent-memory test -- --coverage --coverageReporters=text --coverageReporters=lcov --coverageReporters=json-summary --passWithNoTests --ci"
            coverage-dir: "packages/@wundr/agent-memory/coverage"

          # computer-setup uses jest
          - package: computer-setup
            scope: "@wundr.io/computer-setup"
            runner: jest
            test-cmd: "pnpm --filter @wundr.io/computer-setup test -- --coverage --coverageReporters=text --coverageReporters=lcov --coverageReporters=json-summary --passWithNoTests --ci"
            coverage-dir: "packages/@wundr/computer-setup/coverage"

          # cli uses jest
          - package: cli
            scope: "@wundr.io/cli"
            runner: jest
            test-cmd: "pnpm --filter @wundr.io/cli test -- --coverage --coverageReporters=text --coverageReporters=lcov --coverageReporters=json-summary --passWithNoTests --ci"
            coverage-dir: "packages/@wundr/cli/coverage"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      # Build workspace dependencies first (some packages depend on @wundr.io/core, etc.)
      - name: Build dependencies
        run: pnpm turbo build --filter="${{ matrix.scope }}..."
        env:
          NODE_ENV: production

      - name: Run tests with coverage
        run: ${{ matrix.test-cmd }}
        env:
          NODE_ENV: test

      - name: Enforce coverage thresholds
        if: always()
        run: |
          COVERAGE_DIR="${{ matrix.coverage-dir }}"

          # Locate coverage-summary.json (vitest puts it at coverage/coverage-summary.json,
          # jest at coverage/coverage-summary.json by default)
          SUMMARY=""
          for candidate in \
            "${COVERAGE_DIR}/coverage-summary.json" \
            "${COVERAGE_DIR}/coverage/coverage-summary.json"; do
            if [ -f "$candidate" ]; then
              SUMMARY="$candidate"
              break
            fi
          done

          if [ -z "$SUMMARY" ]; then
            echo "No coverage-summary.json found in ${COVERAGE_DIR}."
            echo "Coverage threshold check skipped for ${{ matrix.package }}."
            echo "Ensure the test runner produces json-summary output."
            exit 0
          fi

          echo "Coverage summary: $SUMMARY"
          cat "$SUMMARY" | jq '.total'

          # Extract percentages
          LINES=$(jq -r '.total.lines.pct // 0' "$SUMMARY")
          FUNCTIONS=$(jq -r '.total.functions.pct // 0' "$SUMMARY")
          BRANCHES=$(jq -r '.total.branches.pct // 0' "$SUMMARY")

          echo ""
          echo "== Coverage Results for ${{ matrix.package }} =="
          echo "  Lines:     ${LINES}%  (threshold: 80%)"
          echo "  Functions: ${FUNCTIONS}%  (threshold: 80%)"
          echo "  Branches:  ${BRANCHES}%  (threshold: 70%)"
          echo ""

          FAILED=false

          check_threshold() {
            local metric="$1"
            local actual="$2"
            local threshold="$3"
            # Use awk for portable floating-point comparison
            if echo "$actual $threshold" | awk '{ exit ($1 < $2) ? 0 : 1 }'; then
              echo "FAIL: ${metric} coverage ${actual}% is below ${threshold}%"
              FAILED=true
            else
              echo "PASS: ${metric} coverage ${actual}% >= ${threshold}%"
            fi
          }

          check_threshold "Lines"     "$LINES"     80
          check_threshold "Functions" "$FUNCTIONS"  80
          check_threshold "Branches"  "$BRANCHES"   70

          echo ""
          if [ "$FAILED" = "true" ]; then
            echo "Coverage thresholds not met for ${{ matrix.package }}"
            exit 1
          fi

          echo "All coverage thresholds passed for ${{ matrix.package }}"

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: ${{ matrix.coverage-dir }}
          retention-days: 14
          if-no-files-found: warn

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ${{ matrix.coverage-dir }}
          flags: ${{ matrix.package }}
          fail_ci_if_error: false

  # ===========================================================================
  # 5. INTEGRATION TESTS -- full cross-package integration suite
  # ===========================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Run integration tests
        run: pnpm turbo test:integration -- --passWithNoTests
        env:
          NODE_ENV: test

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test-results/
            **/test-results/
          retention-days: 7

  # ===========================================================================
  # 6. SECURITY -- dependency audit + license compliance (parallel with lint)
  # ===========================================================================
  security:
    name: Security & Licenses
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      # -----------------------------------------------------------------------
      # 6a. Dependency vulnerability audit
      # -----------------------------------------------------------------------
      - name: Dependency audit
        run: |
          echo "== Running pnpm audit =="

          # Capture full audit output
          pnpm audit --audit-level moderate --json > audit-results.json 2>&1 || true

          # Fail on critical/high vulnerabilities
          if pnpm audit --audit-level high 2>&1 | grep -qiE "critical|high"; then
            echo ""
            echo "High or critical vulnerabilities detected:"
            pnpm audit --audit-level high
            exit 1
          fi

          echo "No high/critical vulnerabilities found."

      # -----------------------------------------------------------------------
      # 6b. Hardcoded credentials scan
      # -----------------------------------------------------------------------
      - name: Scan for hardcoded credentials
        run: |
          FOUND_ISSUES=0

          for pattern in \
            'password\s*=\s*["\x27][^"\x27]+' \
            'secret\s*=\s*["\x27][^"\x27]+' \
            'api_key\s*=\s*["\x27][^"\x27]+' \
            'private_key\s*=\s*["\x27][^"\x27]+'; do
            if grep -rnE "$pattern" src/ packages/ tools/ --include="*.ts" --include="*.js" \
               --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git 2>/dev/null | \
               grep -v "test" | grep -v "spec" | grep -v "mock" | grep -v "example" | \
               grep -v "\.env\.example" | head -5; then
              echo "Potential hardcoded credential found"
              FOUND_ISSUES=$((FOUND_ISSUES + 1))
            fi
          done

          if [ "$FOUND_ISSUES" -gt 0 ]; then
            echo "Found $FOUND_ISSUES potential credential patterns. Review the output above."
          else
            echo "No hardcoded credential patterns detected."
          fi

      # -----------------------------------------------------------------------
      # 6c. License compliance check
      # -----------------------------------------------------------------------
      - name: License compliance check
        run: |
          echo "== License Compliance Check =="

          # Install license-checker if not available
          npx license-checker --production --json --out license-report.json 2>/dev/null || {
            echo "license-checker not available, falling back to pnpm licenses"
            pnpm licenses list --json > license-report.json 2>/dev/null || true
          }

          # Define blocked licenses (copyleft licenses incompatible with MIT)
          BLOCKED_LICENSES="GPL-2.0-only|GPL-3.0-only|GPL-2.0-or-later|GPL-3.0-or-later|AGPL-1.0|AGPL-3.0|AGPL-3.0-only|SSPL-1.0|EUPL-1.1|EUPL-1.2"

          # Check for blocked licenses in the report
          if [ -f "license-report.json" ]; then
            VIOLATIONS=$(cat license-report.json | grep -oiE "$BLOCKED_LICENSES" | sort -u || true)
            if [ -n "$VIOLATIONS" ]; then
              echo "Blocked licenses found in production dependencies:"
              echo "$VIOLATIONS"
              echo ""
              echo "The following licenses are not compatible with this project's MIT license."
              echo "Review and replace the offending dependencies."
              exit 1
            fi
          fi

          echo "License compliance check passed. No blocked licenses found."

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            audit-results.json
            license-report.json
          retention-days: 30

  # ===========================================================================
  # 6d. DEPENDENCY REVIEW -- GitHub's built-in PR dependency diff (PR only)
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD, Unlicense, CC0-1.0, CC-BY-3.0, CC-BY-4.0, Artistic-2.0, Zlib, BlueOak-1.0.0
          deny-licenses: GPL-2.0-only, GPL-3.0-only, AGPL-3.0-only, SSPL-1.0

  # ===========================================================================
  # 7. BUILD -- full workspace build + artifact upload
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, test-integration]
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
            packages/@wundr/*/node_modules
            packages/@wundr/neolith/packages/@neolith/*/node_modules
            tools/*/node_modules
            config/*/node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Build all packages
        run: pnpm turbo build

      - name: Verify build outputs
        run: |
          echo "== Verifying build outputs =="
          MISSING=0
          CHECKED=0

          for dir in \
            "packages/@wundr/core/dist" \
            "packages/@wundr/config/dist" \
            "packages/@wundr/orchestrator-daemon/dist" \
            "packages/@wundr/agent-memory/dist" \
            "packages/@wundr/computer-setup/dist" \
            "packages/@wundr/cli/dist"; do
            CHECKED=$((CHECKED + 1))
            if [ -d "$dir" ]; then
              FILE_COUNT=$(find "$dir" -type f | wc -l)
              echo "  OK: $dir ($FILE_COUNT files)"
            else
              echo "  MISSING: $dir"
              MISSING=$((MISSING + 1))
            fi
          done

          echo ""
          echo "Checked $CHECKED directories, $MISSING missing."

          if [ "$MISSING" -gt 0 ]; then
            echo "One or more expected build outputs are missing."
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: |
            packages/@wundr/orchestrator-daemon/dist/
            packages/@wundr/agent-memory/dist/
            packages/@wundr/computer-setup/dist/
            packages/@wundr/cli/dist/
            packages/@wundr/core/dist/
            packages/@wundr/config/dist/
          retention-days: 7

  # ===========================================================================
  # 8. CI STATUS -- aggregate gate for branch protection / PR checks
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - test
      - test-integration
      - security
      - build
    if: always()
    timeout-minutes: 5
    steps:
      - name: Evaluate pipeline status
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TYPECHECK_RESULT: ${{ needs.typecheck.result }}
          TEST_RESULT: ${{ needs.test.result }}
          INTEGRATION_RESULT: ${{ needs.test-integration.result }}
          SECURITY_RESULT: ${{ needs.security.result }}
          BUILD_RESULT: ${{ needs.build.result }}
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint (ESLint + Prettier) | ${LINT_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Typecheck (tsc --noEmit) | ${TYPECHECK_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (per-package matrix) | ${TEST_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${INTEGRATION_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security & Licenses | ${SECURITY_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${BUILD_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status -- fail if any required job failed
          FAILED=false

          for result in \
            "$LINT_RESULT" \
            "$TYPECHECK_RESULT" \
            "$TEST_RESULT" \
            "$INTEGRATION_RESULT" \
            "$BUILD_RESULT"; do
            if [ "$result" = "failure" ]; then
              FAILED=true
            fi
          done

          # Security is advisory -- log but do not block merges
          if [ "$SECURITY_RESULT" = "failure" ]; then
            echo "**Warning:** Security & License check failed. Review audit results." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" = "true" ]; then
            echo "**Status: FAILED** -- One or more required checks did not pass." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "**Status: PASSED** -- All required checks succeeded." >> $GITHUB_STEP_SUMMARY
