// Genesis App Database Schema
// Wave 2 (Phase 0.5) - Complete Schema Extensions
// This is the source of truth for the database structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Enums
// =============================================================================

/// User account status
enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

/// VP (Virtual Person) online status
enum VPStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

/// Workspace visibility level
enum WorkspaceVisibility {
  PUBLIC
  PRIVATE
  INTERNAL
}

/// Channel type enumeration
enum ChannelType {
  PUBLIC
  PRIVATE
  DM
  HUDDLE
}

/// Message type enumeration
enum MessageType {
  TEXT
  FILE
  SYSTEM
  COMMAND
}

/// File processing status
enum FileStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

/// Organization member role
enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

/// Workspace member role
enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

/// Channel member role
enum ChannelRole {
  OWNER
  ADMIN
  MEMBER
}

// =============================================================================
// Core Models
// =============================================================================

/// Organization - Top-level entity containing workspaces
model Organization {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  avatarUrl   String? @map("avatar_url")
  description String?
  settings    Json    @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workspaces Workspace[]
  members    OrganizationMember[]
  vps        VP[]

  @@index([slug])
  @@map("organizations")
}

/// Workspace - Main collaboration space within an organization
model Workspace {
  id          String              @id @default(cuid())
  name        String
  slug        String
  description String?
  avatarUrl   String?             @map("avatar_url")
  visibility  WorkspaceVisibility @default(PRIVATE)
  settings    Json                @default("{}")

  // Foreign keys
  organizationId String @map("organization_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channels          Channel[]
  members           WorkspaceMember[]
  files             File[]
  daemonCredentials DaemonCredential[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@map("workspaces")
}

/// User - Human or VP account
model User {
  id          String     @id @default(cuid())
  email       String     @unique
  name        String?
  displayName String?    @map("display_name")
  avatarUrl   String?    @map("avatar_url")
  bio         String?
  status      UserStatus @default(PENDING)
  isVP        Boolean    @default(false) @map("is_vp")
  vpConfig    Json?      @map("vp_config")
  preferences Json       @default("{}")

  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastActiveAt DateTime? @map("last_active_at")

  // Relations
  organizationMemberships OrganizationMember[]
  workspaceMemberships    WorkspaceMember[]
  channelMemberships      ChannelMember[]
  messages                Message[]
  files                   File[]
  sessions                Session[]
  reactions               Reaction[]
  createdChannels         Channel[]            @relation("ChannelCreator")
  vp                      VP?
  notifications           Notification[]
  pushSubscriptions       PushSubscription[]

  @@index([email])
  @@index([status])
  @@map("users")
}

/// VP (Virtual Person) - AI agent metadata
model VP {
  id             String   @id @default(cuid())
  discipline     String
  role           String
  capabilities   Json     @default("[]")
  daemonEndpoint String?  @map("daemon_endpoint")
  status         VPStatus @default(OFFLINE)

  // Foreign keys
  userId         String  @unique @map("user_id")
  organizationId String  @map("organization_id")
  workspaceId    String? @map("workspace_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  daemonCredentials DaemonCredential[]

  @@index([organizationId])
  @@index([workspaceId])
  @@index([discipline])
  @@index([status])
  @@map("vps")
}

/// Channel - Communication channel within a workspace
model Channel {
  id          String      @id @default(cuid())
  name        String
  slug        String
  description String?
  topic       String?
  type        ChannelType @default(PUBLIC)
  isArchived  Boolean     @default(false) @map("is_archived")
  settings    Json        @default("{}")

  // Foreign keys
  workspaceId String  @map("workspace_id")
  createdById String? @map("created_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workspace Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User?           @relation("ChannelCreator", fields: [createdById], references: [id], onDelete: SetNull)
  messages  Message[]
  members   ChannelMember[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([type])
  @@index([isArchived])
  @@map("channels")
}

/// Message - Chat message within a channel
model Message {
  id       String      @id @default(cuid())
  content  String
  type     MessageType @default(TEXT)
  metadata Json        @default("{}")

  // Edit/delete tracking
  isEdited  Boolean   @default(false) @map("is_edited")
  isDeleted Boolean   @default(false) @map("is_deleted")
  editedAt  DateTime? @map("edited_at")
  deletedAt DateTime? @map("deleted_at")

  // Foreign keys
  channelId String  @map("channel_id")
  authorId  String  @map("author_id")
  parentId  String? @map("parent_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  channel     Channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author      User                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent      Message?            @relation("MessageThread", fields: [parentId], references: [id], onDelete: SetNull)
  replies     Message[]           @relation("MessageThread")
  reactions   Reaction[]
  attachments MessageAttachment[]

  @@index([channelId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
  @@index([type])
  @@index([deletedAt])
  @@map("messages")
}

/// File - Uploaded file metadata
model File {
  id           String     @id @default(cuid())
  filename     String
  originalName String     @map("original_name")
  mimeType     String     @map("mime_type")
  size         BigInt
  s3Key        String     @map("s3_key")
  s3Bucket     String     @map("s3_bucket")
  thumbnailUrl String?    @map("thumbnail_url")
  status       FileStatus @default(PENDING)
  metadata     Json       @default("{}")

  // Foreign keys
  workspaceId  String @map("workspace_id")
  uploadedById String @map("uploaded_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  uploader    User                @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  attachments MessageAttachment[]

  @@index([workspaceId])
  @@index([uploadedById])
  @@index([status])
  @@index([mimeType])
  @@map("files")
}

// =============================================================================
// Membership/Junction Models
// =============================================================================

/// OrganizationMember - User membership in an organization
model OrganizationMember {
  id   String           @id @default(cuid())
  role OrganizationRole @default(MEMBER)

  // Foreign keys
  organizationId String @map("organization_id")
  userId         String @map("user_id")

  // Timestamps
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

/// WorkspaceMember - User membership in a workspace
model WorkspaceMember {
  id   String        @id @default(cuid())
  role WorkspaceRole @default(MEMBER)

  // Foreign keys
  workspaceId String @map("workspace_id")
  userId      String @map("user_id")

  // Timestamps
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

/// ChannelMember - User membership in a channel
model ChannelMember {
  id   String      @id @default(cuid())
  role ChannelRole @default(MEMBER)

  // Foreign keys
  channelId String @map("channel_id")
  userId    String @map("user_id")

  // Timestamps
  joinedAt   DateTime  @default(now()) @map("joined_at")
  lastReadAt DateTime? @map("last_read_at")
  leftAt     DateTime? @map("left_at")

  // Relations
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
  @@index([leftAt])
  @@map("channel_members")
}

// =============================================================================
// Supporting Models
// =============================================================================

/// Reaction - Message reaction (emoji)
model Reaction {
  id    String @id @default(cuid())
  emoji String

  // Foreign keys
  messageId String @map("message_id")
  userId    String @map("user_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("reactions")
}

/// MessageAttachment - Junction table for messages and files
model MessageAttachment {
  id String @id @default(cuid())

  // Foreign keys
  messageId String @map("message_id")
  fileId    String @map("file_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  file    File    @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([messageId, fileId])
  @@index([messageId])
  @@index([fileId])
  @@map("message_attachments")
}

/// Session - User session for authentication
model Session {
  id         String   @id @default(cuid())
  token      String   @unique
  deviceInfo Json?    @map("device_info")
  ipAddress  String?  @map("ip_address")
  expiresAt  DateTime @map("expires_at")

  // Foreign keys
  userId String @map("user_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// =============================================================================
// Notification Models
// =============================================================================

/// Notification type enumeration
enum NotificationType {
  MESSAGE
  MENTION
  THREAD_REPLY
  CALL
  CHANNEL_INVITE
  ORGANIZATION_UPDATE
  SYSTEM
}

/// Notification priority enumeration
enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

/// Push platform enumeration
enum PushPlatform {
  web
  ios
  android
}

/// Notification - User notification
model Notification {
  id           String               @id @default(cuid())
  title        String
  body         String
  type         NotificationType
  priority     NotificationPriority @default(NORMAL)
  resourceId   String?              @map("resource_id")
  resourceType String?              @map("resource_type")
  actionUrl    String?              @map("action_url")
  metadata     Json                 @default("{}")
  read         Boolean              @default(false)
  readAt       DateTime?            @map("read_at")
  archived     Boolean              @default(false)
  expiresAt    DateTime?            @map("expires_at")

  // Foreign keys
  userId String @map("user_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

/// PushSubscription - Device push notification subscription
model PushSubscription {
  id                 String       @id @default(cuid())
  token              String       @unique
  platform           PushPlatform
  userAgent          String?      @map("user_agent")
  deviceName         String?      @map("device_name")
  deviceModel        String?      @map("device_model")
  appVersion         String?      @map("app_version")
  active             Boolean      @default(true)
  deactivatedAt      DateTime?    @map("deactivated_at")
  deactivationReason String?      @map("deactivation_reason")
  failureCount       Int          @default(0) @map("failure_count")
  lastFailureAt      DateTime?    @map("last_failure_at")
  lastFailureReason  String?      @map("last_failure_reason")

  // Foreign keys
  userId String @map("user_id")

  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastActiveAt DateTime? @map("last_active_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([platform])
  @@index([active])
  @@map("push_subscriptions")
}

// =============================================================================
// Daemon Models
// =============================================================================

/// DaemonCredential - Credentials for VP daemon authentication
model DaemonCredential {
  id            String   @id @default(cuid())
  apiKey        String   @unique @map("api_key")
  apiSecretHash String   @map("api_secret_hash")
  hostname      String?
  version       String?
  capabilities  String[]
  metadata      Json?
  isActive      Boolean  @default(true) @map("is_active")

  // Foreign keys
  vpId        String @map("vp_id")
  workspaceId String @map("workspace_id")

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")

  // Relations
  vp        VP        @relation(fields: [vpId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([vpId])
  @@index([workspaceId])
  @@index([apiKey])
  @@index([isActive])
  @@map("daemon_credentials")
}
