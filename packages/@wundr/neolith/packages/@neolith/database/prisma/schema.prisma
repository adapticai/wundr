generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                  String   @id
  user_id             String
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  created_at          DateTime @default(now())
  updated_at          DateTime
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
  @@index([user_id])
}

model backlog_items {
  id         String   @id
  position   Int      @default(0)
  backlog_id String
  task_id    String
  added_at   DateTime @default(now())
  backlogs   backlogs @relation(fields: [backlog_id], references: [id], onDelete: Cascade)
  tasks      tasks    @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@unique([backlog_id, task_id])
  @@index([backlog_id])
  @@index([position])
  @@index([task_id])
}

model backlogs {
  id            String          @id
  name          String
  description   String?
  status        String          @default("active")
  priority      Int             @default(0)
  metadata      Json            @default("{}")
  vp_id         String
  workspace_id  String
  created_at    DateTime        @default(now())
  updated_at    DateTime
  backlog_items backlog_items[]
  vps           vps             @relation(fields: [vp_id], references: [id], onDelete: Cascade)
  workspaces    workspaces      @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([vp_id, name])
  @@index([priority])
  @@index([status])
  @@index([vp_id])
  @@index([workspace_id])
}

model channel_members {
  id           String      @id
  role         ChannelRole @default(MEMBER)
  channel_id   String
  user_id      String
  joined_at    DateTime    @default(now())
  last_read_at DateTime?
  left_at      DateTime?
  channels     channels    @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  users        users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([channel_id, user_id])
  @@index([channel_id])
  @@index([left_at])
  @@index([user_id])
}

model channels {
  id              String            @id
  name            String
  slug            String
  description     String?
  topic           String?
  type            ChannelType       @default(PUBLIC)
  is_archived     Boolean           @default(false)
  settings        Json              @default("{}")
  workspace_id    String
  created_by_id   String?
  created_at      DateTime          @default(now())
  updated_at      DateTime
  channel_members channel_members[]
  users           users?            @relation(fields: [created_by_id], references: [id])
  workspaces      workspaces        @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  messages        messages[]
  tasks           tasks[]

  @@unique([workspace_id, slug])
  @@index([is_archived])
  @@index([type])
  @@index([workspace_id])
}

model daemon_credentials {
  id              String     @id
  api_key         String     @unique
  api_secret_hash String
  hostname        String?
  version         String?
  capabilities    String[]
  metadata        Json?
  is_active       Boolean    @default(true)
  vp_id           String
  workspace_id    String
  created_at      DateTime   @default(now())
  updated_at      DateTime
  expires_at      DateTime?
  last_used_at    DateTime?
  vps             vps        @relation(fields: [vp_id], references: [id], onDelete: Cascade)
  workspaces      workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([api_key])
  @@index([is_active])
  @@index([vp_id])
  @@index([workspace_id])
}

model disciplines {
  id              String        @id
  name            String
  description     String?
  color           String?
  icon            String?
  organization_id String
  created_at      DateTime      @default(now())
  updated_at      DateTime
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  vps             vps[]

  @@unique([organization_id, name])
  @@index([name])
  @@index([organization_id])
}

model files {
  id                  String                @id
  filename            String
  original_name       String
  mime_type           String
  size                BigInt
  s3_key              String
  s3_bucket           String
  thumbnail_url       String?
  status              FileStatus            @default(PENDING)
  metadata            Json                  @default("{}")
  workspace_id        String
  uploaded_by_id      String
  created_at          DateTime              @default(now())
  updated_at          DateTime
  users               users                 @relation(fields: [uploaded_by_id], references: [id], onDelete: Cascade)
  workspaces          workspaces            @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  message_attachments message_attachments[]

  @@index([mime_type])
  @@index([status])
  @@index([uploaded_by_id])
  @@index([workspace_id])
}

model message_attachments {
  id         String   @id
  message_id String
  file_id    String
  created_at DateTime @default(now())
  files      files    @relation(fields: [file_id], references: [id], onDelete: Cascade)
  messages   messages @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@unique([message_id, file_id])
  @@index([file_id])
  @@index([message_id])
}

model messages {
  id                  String                @id
  content             String
  type                MessageType           @default(TEXT)
  metadata            Json                  @default("{}")
  is_edited           Boolean               @default(false)
  is_deleted          Boolean               @default(false)
  edited_at           DateTime?
  deleted_at          DateTime?
  channel_id          String
  author_id           String
  parent_id           String?
  created_at          DateTime              @default(now())
  updated_at          DateTime
  message_attachments message_attachments[]
  users               users                 @relation(fields: [author_id], references: [id], onDelete: Cascade)
  channels            channels              @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  messages            messages?             @relation("messagesTomessages", fields: [parent_id], references: [id])
  other_messages      messages[]            @relation("messagesTomessages")
  reactions           reactions[]

  @@index([author_id])
  @@index([channel_id])
  @@index([created_at])
  @@index([deleted_at])
  @@index([parent_id])
  @@index([type])
}

model notifications {
  id            String               @id
  title         String
  body          String
  type          NotificationType
  priority      NotificationPriority @default(NORMAL)
  resource_id   String?
  resource_type String?
  action_url    String?
  metadata      Json                 @default("{}")
  read          Boolean              @default(false)
  read_at       DateTime?
  archived      Boolean              @default(false)
  expires_at    DateTime?
  user_id       String
  created_at    DateTime             @default(now())
  updated_at    DateTime
  users         users                @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([priority])
  @@index([read])
  @@index([type])
  @@index([user_id])
}

model organization_members {
  id              String           @id
  role            OrganizationRole @default(MEMBER)
  organization_id String
  user_id         String
  joined_at       DateTime         @default(now())
  organizations   organizations    @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  users           users            @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, user_id])
  @@index([organization_id])
  @@index([user_id])
}

model organizations {
  id                   String                 @id
  name                 String
  slug                 String                 @unique
  avatar_url           String?
  description          String?
  settings             Json                   @default("{}")
  created_at           DateTime               @default(now())
  updated_at           DateTime
  disciplines          disciplines[]
  organization_members organization_members[]
  vps                  vps[]
  workspaces           workspaces[]

  @@index([slug])
}

model push_subscriptions {
  id                  String       @id
  token               String       @unique
  platform            PushPlatform
  user_agent          String?
  device_name         String?
  device_model        String?
  app_version         String?
  active              Boolean      @default(true)
  deactivated_at      DateTime?
  deactivation_reason String?
  failure_count       Int          @default(0)
  last_failure_at     DateTime?
  last_failure_reason String?
  user_id             String
  created_at          DateTime     @default(now())
  updated_at          DateTime
  last_active_at      DateTime?
  users               users        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([platform])
  @@index([token])
  @@index([user_id])
}

model reactions {
  id         String   @id
  emoji      String
  message_id String
  user_id    String
  created_at DateTime @default(now())
  messages   messages @relation(fields: [message_id], references: [id], onDelete: Cascade)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id, emoji])
  @@index([message_id])
  @@index([user_id])
}

model sessions {
  id            String   @id
  session_token String   @unique
  expires       DateTime
  user_id       String
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([session_token])
  @@index([user_id])
}

model tasks {
  id                                String          @id
  title                             String
  description                       String?
  priority                          TaskPriority    @default(MEDIUM)
  status                            TaskStatus      @default(TODO)
  due_date                          DateTime?
  estimated_hours                   Int?
  tags                              String[]        @default([])
  metadata                          Json            @default("{}")
  depends_on                        String[]        @default([])
  vp_id                             String
  workspace_id                      String
  channel_id                        String?
  created_by_id                     String
  assigned_to_id                    String?
  created_at                        DateTime        @default(now())
  updated_at                        DateTime
  completed_at                      DateTime?
  backlog_items                     backlog_items[]
  users_tasks_assigned_to_idTousers users?          @relation("tasks_assigned_to_idTousers", fields: [assigned_to_id], references: [id])
  channels                          channels?       @relation(fields: [channel_id], references: [id])
  users_tasks_created_by_idTousers  users           @relation("tasks_created_by_idTousers", fields: [created_by_id], references: [id])
  vps                               vps             @relation(fields: [vp_id], references: [id], onDelete: Cascade)
  workspaces                        workspaces      @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([assigned_to_id])
  @@index([channel_id])
  @@index([created_at])
  @@index([created_by_id])
  @@index([due_date])
  @@index([priority])
  @@index([status])
  @@index([vp_id])
  @@index([workspace_id])
}

model users {
  id                                String                 @id
  email                             String                 @unique
  name                              String?
  display_name                      String?
  avatar_url                        String?
  bio                               String?
  status                            UserStatus             @default(PENDING)
  is_vp                             Boolean                @default(false)
  vp_config                         Json?
  preferences                       Json                   @default("{}")
  created_at                        DateTime               @default(now())
  updated_at                        DateTime
  last_active_at                    DateTime?
  email_verified                    DateTime?
  accounts                          accounts[]
  channel_members                   channel_members[]
  channels                          channels[]
  files                             files[]
  messages                          messages[]
  notifications                     notifications[]
  organization_members              organization_members[]
  push_subscriptions                push_subscriptions[]
  reactions                         reactions[]
  sessions                          sessions[]
  tasks_tasks_assigned_to_idTousers tasks[]                @relation("tasks_assigned_to_idTousers")
  tasks_tasks_created_by_idTousers  tasks[]                @relation("tasks_created_by_idTousers")
  vps                               vps?
  workspace_members                 workspace_members[]

  @@index([email])
  @@index([status])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model vps {
  id                 String               @id
  discipline         String
  role               String
  capabilities       Json                 @default("[]")
  daemon_endpoint    String?
  status             VPStatus             @default(OFFLINE)
  user_id            String               @unique
  organization_id    String
  workspace_id       String?
  discipline_id      String?
  created_at         DateTime             @default(now())
  updated_at         DateTime
  backlogs           backlogs[]
  daemon_credentials daemon_credentials[]
  tasks              tasks[]
  disciplines        disciplines?         @relation(fields: [discipline_id], references: [id])
  organizations      organizations        @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  users              users                @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([discipline_id])
  @@index([discipline])
  @@index([organization_id])
  @@index([status])
  @@index([workspace_id])
}

model workflow_executions {
  id            String                  @id
  status        WorkflowExecutionStatus @default(PENDING)
  triggered_by  String
  trigger_type  String
  trigger_data  Json?
  steps         Json                    @default("[]")
  error         String?
  started_at    DateTime                @default(now())
  completed_at  DateTime?
  duration_ms   Int?
  is_simulation Boolean                 @default(false)
  workflow_id   String
  workspace_id  String
  workflows     workflows               @relation(fields: [workflow_id], references: [id], onDelete: Cascade)

  @@index([is_simulation])
  @@index([started_at])
  @@index([status])
  @@index([triggered_by])
  @@index([workflow_id])
  @@index([workspace_id])
}

model workflows {
  id                  String                @id
  name                String
  description         String?
  trigger             Json
  actions             Json
  status              WorkflowStatus        @default(DRAFT)
  tags                String[]              @default([])
  metadata            Json?
  execution_count     Int                   @default(0)
  success_count       Int                   @default(0)
  failure_count       Int                   @default(0)
  workspace_id        String
  created_by          String
  created_at          DateTime              @default(now())
  updated_at          DateTime
  last_executed_at    DateTime?
  workflow_executions workflow_executions[]
  workspaces          workspaces            @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([workspace_id, name])
  @@index([created_at])
  @@index([created_by])
  @@index([status])
  @@index([workspace_id])
}

model workspace_members {
  id           String        @id
  role         WorkspaceRole @default(MEMBER)
  workspace_id String
  user_id      String
  joined_at    DateTime      @default(now())
  users        users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workspaces   workspaces    @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([workspace_id, user_id])
  @@index([user_id])
  @@index([workspace_id])
}

model workspaces {
  id                 String               @id
  name               String
  slug               String
  description        String?
  avatar_url         String?
  visibility         WorkspaceVisibility  @default(PRIVATE)
  settings           Json                 @default("{}")
  organization_id    String
  created_at         DateTime             @default(now())
  updated_at         DateTime
  backlogs           backlogs[]
  channels           channels[]
  daemon_credentials daemon_credentials[]
  files              files[]
  tasks              tasks[]
  workflows          workflows[]
  workspace_members  workspace_members[]
  integrations       integrations[]
  organizations      organizations        @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, slug])
  @@index([organization_id])
  @@index([slug])
}

enum ChannelRole {
  OWNER
  ADMIN
  MEMBER
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DM
  HUDDLE
}

enum FileStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  COMMAND
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  MESSAGE
  MENTION
  THREAD_REPLY
  CALL
  CHANNEL_INVITE
  ORGANIZATION_UPDATE
  SYSTEM
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

enum PushPlatform {
  web
  ios
  android
}

enum TaskPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELLED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum VPStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

enum WorkflowStatus {
  ACTIVE
  INACTIVE
  DRAFT
  ARCHIVED
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum WorkspaceVisibility {
  PUBLIC
  PRIVATE
  INTERNAL
}

// =============================================================================
// Integration Models (Phase 8 - Workspace Integrations)
// =============================================================================

/// Integration status enumeration
enum IntegrationStatus {
  ACTIVE
  INACTIVE
  PENDING
  ERROR
  REVOKED
}

/// Integration provider enumeration
enum IntegrationProvider {
  SLACK
  GITHUB
  GITLAB
  JIRA
  LINEAR
  NOTION
  GOOGLE_DRIVE
  MICROSOFT_365
  ZAPIER
  CUSTOM
}

/// Integration - Third-party service integration configuration
model integrations {
  id            String              @id
  name          String
  description   String?
  provider      IntegrationProvider
  status        IntegrationStatus   @default(PENDING)
  access_token  String?             @db.Text
  refresh_token String?             @db.Text
  expires_at    DateTime?
  config        Json                @default("{}")
  sync_enabled  Boolean             @default(false)
  last_sync_at  DateTime?
  sync_error    String?
  workspace_id  String
  connected_by  String
  created_at    DateTime            @default(now())
  updated_at    DateTime
  connected_at  DateTime?
  workspaces    workspaces          @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
  @@index([provider])
  @@index([status])
  @@index([connected_by])
  @@index([created_at])
}
