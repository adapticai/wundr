generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model account {
  id                  String    @id @default(cuid())
  userId              String   @map("user_id")
  type                String
  provider            String
  providerAccountId   String   @map("provider_account_id")
  refreshToken        String?  @map("refresh_token")
  accessToken         String?  @map("access_token")
  expiresAt           Int?     @map("expires_at")
  tokenType           String?  @map("token_type")
  scope               String?
  idToken             String?  @map("id_token")
  sessionState        String?  @map("session_state")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  user                user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model backlogItem {
  id        String    @id @default(cuid())
  position  Int      @default(0)
  backlogId String   @map("backlog_id")
  taskId    String   @map("task_id")
  addedAt   DateTime @default(now()) @map("added_at")
  backlog   backlog  @relation(fields: [backlogId], references: [id], onDelete: Cascade)
  task      task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([backlogId, taskId])
  @@index([backlogId])
  @@index([position])
  @@index([taskId])
  @@map("backlog_items")
}

model backlog {
  id           String         @id @default(cuid())
  name         String
  description  String?
  status       String        @default("active")
  priority     Int           @default(0)
  metadata     Json          @default("{}")
  vpId         String        @map("vp_id")
  workspaceId  String        @map("workspace_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  backlogItems backlogItem[]
  vp           vP            @relation(fields: [vpId], references: [id], onDelete: Cascade)
  workspace    workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([vpId, name])
  @@index([priority])
  @@index([status])
  @@index([vpId])
  @@index([workspaceId])
  @@map("backlogs")
}

model channelMember {
  id         String       @id @default(cuid())
  role       ChannelRole @default(MEMBER)
  channelId  String      @map("channel_id")
  userId     String      @map("user_id")
  joinedAt   DateTime    @default(now()) @map("joined_at")
  lastReadAt DateTime?   @map("last_read_at")
  leftAt     DateTime?   @map("left_at")
  channel    channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user       user        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([leftAt])
  @@index([userId])
  @@map("channel_members")
}

model channel {
  id             String           @id @default(cuid())
  name           String
  slug           String
  description    String?
  topic          String?
  type           ChannelType     @default(PUBLIC)
  isArchived     Boolean         @default(false) @map("is_archived")
  settings       Json            @default("{}")
  workspaceId    String          @map("workspace_id")
  createdById    String?         @map("created_by_id")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  channelMembers channelMember[]
  createdBy      user?           @relation(fields: [createdById], references: [id])
  workspace      workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages       message[]
  tasks          task[]

  @@unique([workspaceId, slug])
  @@index([isArchived])
  @@index([type])
  @@index([workspaceId])
  @@map("channels")
}

model daemonCredential {
  id            String      @id @default(cuid())
  apiKey        String     @unique @map("api_key")
  apiSecretHash String     @map("api_secret_hash")
  hostname      String?
  version       String?
  capabilities  String[]
  metadata      Json?
  isActive      Boolean    @default(true) @map("is_active")
  vpId          String     @map("vp_id")
  workspaceId   String     @map("workspace_id")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  expiresAt     DateTime?  @map("expires_at")
  lastUsedAt    DateTime?  @map("last_used_at")
  vp            vP         @relation(fields: [vpId], references: [id], onDelete: Cascade)
  workspace     workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([apiKey])
  @@index([isActive])
  @@index([vpId])
  @@index([workspaceId])
  @@map("daemon_credentials")
}

model discipline {
  id             String        @id @default(cuid())
  name           String
  description    String?
  color          String?
  icon           String?
  organizationId String       @map("organization_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organization   organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vps            vP[]

  @@unique([organizationId, name])
  @@index([name])
  @@index([organizationId])
  @@map("disciplines")
}

model file {
  id                 String               @id @default(cuid())
  filename           String
  originalName       String              @map("original_name")
  mimeType           String              @map("mime_type")
  size               BigInt
  s3Key              String              @map("s3_key")
  s3Bucket           String              @map("s3_bucket")
  thumbnailUrl       String?             @map("thumbnail_url")
  status             FileStatus          @default(PENDING)
  metadata           Json                @default("{}")
  workspaceId        String              @map("workspace_id")
  uploadedById       String              @map("uploaded_by_id")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  uploadedBy         user                @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  workspace          workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messageAttachments messageAttachment[]

  @@index([mimeType])
  @@index([status])
  @@index([uploadedById])
  @@index([workspaceId])
  @@map("files")
}

model messageAttachment {
  id        String    @id @default(cuid())
  messageId String   @map("message_id")
  fileId    String   @map("file_id")
  createdAt DateTime @default(now()) @map("created_at")
  file      file     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  message   message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, fileId])
  @@index([fileId])
  @@index([messageId])
  @@map("message_attachments")
}

model message {
  id                 String               @id @default(cuid())
  content            String
  type               MessageType         @default(TEXT)
  metadata           Json                @default("{}")
  isEdited           Boolean             @default(false) @map("is_edited")
  isDeleted          Boolean             @default(false) @map("is_deleted")
  editedAt           DateTime?           @map("edited_at")
  deletedAt          DateTime?           @map("deleted_at")
  channelId          String              @map("channel_id")
  authorId           String              @map("author_id")
  parentId           String?             @map("parent_id")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  messageAttachments messageAttachment[]
  author             user                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  channel            channel             @relation(fields: [channelId], references: [id], onDelete: Cascade)
  parent             message?            @relation("messageToMessage", fields: [parentId], references: [id])
  replies            message[]           @relation("messageToMessage")
  reactions          reaction[]

  @@index([authorId])
  @@index([channelId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([parentId])
  @@index([type])
  @@map("messages")
}

model notification {
  id           String                @id @default(cuid())
  title        String
  body         String
  type         NotificationType
  priority     NotificationPriority @default(NORMAL)
  resourceId   String?              @map("resource_id")
  resourceType String?              @map("resource_type")
  actionUrl    String?              @map("action_url")
  metadata     Json                 @default("{}")
  read         Boolean              @default(false)
  readAt       DateTime?            @map("read_at")
  archived     Boolean              @default(false)
  expiresAt    DateTime?            @map("expires_at")
  userId       String               @map("user_id")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  user         user                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([priority])
  @@index([read])
  @@index([type])
  @@index([userId])
  @@map("notifications")
}

model organizationMember {
  id             String            @id @default(cuid())
  role           OrganizationRole @default(MEMBER)
  organizationId String           @map("organization_id")
  userId         String           @map("user_id")
  joinedAt       DateTime         @default(now()) @map("joined_at")
  organization   organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           user             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

model organization {
  id                  String                @id @default(cuid())
  name                String
  slug                String               @unique
  avatarUrl           String?              @map("avatar_url")
  description         String?
  settings            Json                 @default("{}")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  disciplines         discipline[]
  organizationMembers organizationMember[]
  vps                 vP[]
  workspaces          workspace[]

  @@index([slug])
  @@map("organizations")
}

model pushSubscription {
  id                  String        @id @default(cuid())
  token               String       @unique
  platform            PushPlatform
  userAgent           String?      @map("user_agent")
  deviceName          String?      @map("device_name")
  deviceModel         String?      @map("device_model")
  appVersion          String?      @map("app_version")
  active              Boolean      @default(true)
  deactivatedAt       DateTime?    @map("deactivated_at")
  deactivationReason  String?      @map("deactivation_reason")
  failureCount        Int          @default(0) @map("failure_count")
  lastFailureAt       DateTime?    @map("last_failure_at")
  lastFailureReason   String?      @map("last_failure_reason")
  userId              String       @map("user_id")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  lastActiveAt        DateTime?    @map("last_active_at")
  user                user         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([platform])
  @@index([token])
  @@index([userId])
  @@map("push_subscriptions")
}

model reaction {
  id        String    @id @default(cuid())
  emoji     String
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  message   message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("reactions")
}

model session {
  id           String    @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  expires      DateTime
  userId       String   @map("user_id")
  user         user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
  @@map("sessions")
}

model task {
  id           String         @id @default(cuid())
  title        String
  description  String?
  priority     TaskPriority  @default(MEDIUM)
  status       TaskStatus    @default(TODO)
  dueDate      DateTime?     @map("due_date")
  estimatedHours Int?        @map("estimated_hours")
  tags         String[]      @default([])
  metadata     Json          @default("{}")
  dependsOn    String[]      @default([]) @map("depends_on")
  vpId         String        @map("vp_id")
  workspaceId  String        @map("workspace_id")
  channelId    String?       @map("channel_id")
  createdById  String        @map("created_by_id")
  assignedToId String?       @map("assigned_to_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  completedAt  DateTime?     @map("completed_at")
  backlogItems backlogItem[]
  assignedTo   user?         @relation("taskAssignedTo", fields: [assignedToId], references: [id])
  channel      channel?      @relation(fields: [channelId], references: [id])
  createdBy    user          @relation("taskCreatedBy", fields: [createdById], references: [id])
  vp           vP            @relation(fields: [vpId], references: [id], onDelete: Cascade)
  workspace    workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([assignedToId])
  @@index([channelId])
  @@index([createdAt])
  @@index([createdById])
  @@index([dueDate])
  @@index([priority])
  @@index([status])
  @@index([vpId])
  @@index([workspaceId])
  @@map("tasks")
}

model user {
  id                  String                @id @default(cuid())
  email               String               @unique
  name                String?
  displayName         String?              @map("display_name")
  avatarUrl           String?              @map("avatar_url")
  bio                 String?
  status              UserStatus           @default(PENDING)
  isVP                Boolean              @default(false) @map("is_vp")
  vpConfig            Json?                @map("vp_config")
  preferences         Json                 @default("{}")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  lastActiveAt        DateTime?            @map("last_active_at")
  emailVerified       DateTime?            @map("email_verified")
  accounts            account[]
  channelMembers      channelMember[]
  channels            channel[]
  files               file[]
  messages            message[]
  notifications       notification[]
  organizationMembers organizationMember[]
  pushSubscriptions   pushSubscription[]
  reactions           reaction[]
  sessions            session[]
  tasksAssignedTo     task[]               @relation("taskAssignedTo")
  tasksCreatedBy      task[]               @relation("taskCreatedBy")
  vp                  vP?
  workspaceMembers    workspaceMember[]

  @@index([email])
  @@index([status])
  webhooks            webhook[]
  @@map("users")
}

model verificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model vP {
  id                String              @id @default(cuid())
  discipline        String
  role              String
  capabilities      Json               @default("[]")
  daemonEndpoint    String?            @map("daemon_endpoint")
  status            VPStatus           @default(OFFLINE)
  userId            String             @unique @map("user_id")
  organizationId    String             @map("organization_id")
  workspaceId       String?            @map("workspace_id")
  disciplineId      String?            @map("discipline_id")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  backlogs          backlog[]
  daemonCredentials daemonCredential[]
  tasks             task[]
  disciplineRef     discipline?        @relation(fields: [disciplineId], references: [id])
  organization      organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              user               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([disciplineId])
  @@index([discipline])
  @@index([organizationId])
  @@index([status])
  @@index([workspaceId])
  vPMemories          vPMemory[]
  @@map("vps")
}

model workflowExecution {
  id           String                   @id @default(cuid())
  status       WorkflowExecutionStatus @default(PENDING)
  triggeredBy  String                  @map("triggered_by")
  triggerType  String                  @map("trigger_type")
  triggerData  Json?                   @map("trigger_data")
  steps        Json                    @default("[]")
  error        String?
  startedAt    DateTime                @default(now()) @map("started_at")
  completedAt  DateTime?               @map("completed_at")
  durationMs   Int?                    @map("duration_ms")
  isSimulation Boolean                 @default(false) @map("is_simulation")
  workflowId   String                  @map("workflow_id")
  workspaceId  String                  @map("workspace_id")
  workflow     workflow                @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([isSimulation])
  @@index([startedAt])
  @@index([status])
  @@index([triggeredBy])
  @@index([workflowId])
  @@index([workspaceId])
  @@map("workflow_executions")
}

model workflow {
  id                 String               @id @default(cuid())
  name               String
  description        String?
  trigger            Json
  actions            Json
  status             WorkflowStatus      @default(DRAFT)
  tags               String[]            @default([])
  metadata           Json?
  executionCount     Int                 @default(0) @map("execution_count")
  successCount       Int                 @default(0) @map("success_count")
  failureCount       Int                 @default(0) @map("failure_count")
  workspaceId        String              @map("workspace_id")
  createdBy          String              @map("created_by")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  lastExecutedAt     DateTime?           @map("last_executed_at")
  workflowExecutions workflowExecution[]
  workspace          workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name])
  @@index([createdAt])
  @@index([createdBy])
  @@index([status])
  @@index([workspaceId])
  @@map("workflows")
}

model workspaceMember {
  id          String         @id @default(cuid())
  role        WorkspaceRole @default(MEMBER)
  workspaceId String        @map("workspace_id")
  userId      String        @map("user_id")
  joinedAt    DateTime      @default(now()) @map("joined_at")
  user        user          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
  @@map("workspace_members")
}

model workspace {
  id                String              @id @default(cuid())
  name              String
  slug              String
  description       String?
  avatarUrl         String?            @map("avatar_url")
  visibility        WorkspaceVisibility @default(PRIVATE)
  settings          Json               @default("{}")
  organizationId    String             @map("organization_id")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  backlogs          backlog[]
  channels          channel[]
  daemonCredentials daemonCredential[]
  files             file[]
  tasks             task[]
  workflows         workflow[]
  workspaceMembers  workspaceMember[]
  integrations      integration[]
  organization      organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  webhooks            webhook[]
  @@map("workspaces")
}

enum ChannelRole {
  OWNER
  ADMIN
  MEMBER
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DM
  HUDDLE
}

enum FileStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  COMMAND
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  MESSAGE
  MENTION
  THREAD_REPLY
  CALL
  CHANNEL_INVITE
  ORGANIZATION_UPDATE
  SYSTEM
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

enum PushPlatform {
  web
  ios
  android
}

enum TaskPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELLED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum VPStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

enum WorkflowStatus {
  ACTIVE
  INACTIVE
  DRAFT
  ARCHIVED
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum WorkspaceVisibility {
  PUBLIC
  PRIVATE
  INTERNAL
}

// =============================================================================
// Integration Models (Phase 8 - Workspace Integrations)
// =============================================================================

/// Integration status enumeration
enum IntegrationStatus {
  ACTIVE
  INACTIVE
  PENDING
  ERROR
  REVOKED
}

/// Integration provider enumeration
enum IntegrationProvider {
  SLACK
  GITHUB
  GITLAB
  JIRA
  LINEAR
  NOTION
  GOOGLE_DRIVE
  MICROSOFT_365
  ZAPIER
  CUSTOM
}

/// Integration - Third-party service integration configuration
model integration {
  id           String               @id @default(cuid())
  name         String
  description  String?
  provider     IntegrationProvider
  status       IntegrationStatus   @default(PENDING)
  accessToken  String?             @map("access_token") @db.Text
  refreshToken String?             @map("refresh_token") @db.Text
  expiresAt    DateTime?           @map("expires_at")
  config       Json                @default("{}")
  syncEnabled  Boolean             @default(false) @map("sync_enabled")
  lastSyncAt   DateTime?           @map("last_sync_at")
  syncError    String?             @map("sync_error")
  workspaceId  String              @map("workspace_id")
  connectedBy  String              @map("connected_by")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  connectedAt  DateTime?           @map("connected_at")
  workspace    workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([provider])
  @@index([status])
  @@index([connectedBy])
  @@index([createdAt])
  @@map("integrations")
}

/// Webhook status
enum WebhookStatus {
  ACTIVE
  INACTIVE
  FAILED
}

/// Webhook delivery status
enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

/// Webhook - Outgoing webhook configuration
model webhook {
  id             String            @id @default(cuid())
  name           String
  url            String
  secret         String?
  events         String[]
  status         WebhookStatus     @default(ACTIVE)
  headers        Json              @default("{}")
  retryAttempts  Int               @default(3) @map("retry_attempts")
  timeout        Int               @default(30000)
  workspaceId    String            @map("workspace_id")
  createdById    String            @map("created_by_id")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  workspace      workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy      user              @relation(fields: [createdById], references: [id])
  deliveries     webhookDelivery[]

  @@index([workspaceId])
  @@index([status])
  @@index([createdById])
  @@map("webhooks")
}

/// WebhookDelivery - Webhook delivery attempt record
model webhookDelivery {
  id              String                @id @default(cuid())
  webhookId       String                @map("webhook_id")
  event           String
  payload         Json
  status          WebhookDeliveryStatus @default(PENDING)
  responseStatus  Int?                  @map("response_status")
  responseBody    String?               @map("response_body") @db.Text
  error           String?               @db.Text
  attemptCount    Int                   @default(0) @map("attempt_count")
  nextRetryAt     DateTime?             @map("next_retry_at")
  createdAt       DateTime              @default(now()) @map("created_at")
  completedAt     DateTime?             @map("completed_at")
  webhook         webhook               @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

/// VPMemory - VP memory entries for conversation context
model vPMemory {
  id          String   @id @default(cuid())
  vpId        String   @map("vp_id")
  memoryType  String   @map("memory_type")
  content     String   @db.Text
  embedding   Json?    
  metadata    Json     @default("{}")
  importance  Float    @default(0.5)
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  vp          vP       @relation(fields: [vpId], references: [id], onDelete: Cascade)

  @@index([vpId])
  @@index([memoryType])
  @@index([importance])
  @@index([createdAt])
  @@map("vp_memories")
}
