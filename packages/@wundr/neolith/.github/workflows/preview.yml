name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.head_ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.0.0"
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_VERCEL_ENV: preview

      - name: Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: Pull Vercel environment information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Preview
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

  comment-preview:
    name: Comment Preview URL
    runs-on: ubuntu-latest
    needs: [build-preview]
    permissions:
      pull-requests: write
    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview Deployment"

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview Deployment

            | Name | Status | URL |
            |------|--------|-----|
            | Genesis App | Ready | [${{ needs.build-preview.outputs.preview-url }}](${{ needs.build-preview.outputs.preview-url }}) |

            ---

            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.head_ref }}
            **Updated:** ${{ github.event.pull_request.updated_at }}

            <details>
            <summary>Deployment Details</summary>

            - **Build Time:** ~${{ github.run_number }} min
            - **Node Version:** ${{ env.NODE_VERSION }}
            - **pnpm Version:** ${{ env.PNPM_VERSION }}

            </details>

            ---
            *This comment will be updated on each push to this PR.*
          edit-mode: replace

  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: [build-preview]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            ${{ needs.build-preview.outputs.preview-url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./.lighthouserc.json

      - name: Format Lighthouse Score
        id: lighthouse-score
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('./lhci_reports/manifest.json', 'utf-8'));
            const summary = results[0]?.summary || {};

            const formatScore = (score) => {
              if (score >= 0.9) return `${Math.round(score * 100)}`;
              if (score >= 0.5) return `${Math.round(score * 100)}`;
              return `${Math.round(score * 100)}`;
            };

            const scores = {
              performance: formatScore(summary.performance || 0),
              accessibility: formatScore(summary.accessibility || 0),
              bestPractices: formatScore(summary['best-practices'] || 0),
              seo: formatScore(summary.seo || 0),
            };

            core.setOutput('scores', JSON.stringify(scores));

      - name: Comment Lighthouse scores
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Lighthouse Scores

            | Category | Score |
            |----------|-------|
            | Performance | ${{ fromJson(steps.lighthouse-score.outputs.scores).performance }} |
            | Accessibility | ${{ fromJson(steps.lighthouse-score.outputs.scores).accessibility }} |
            | Best Practices | ${{ fromJson(steps.lighthouse-score.outputs.scores).bestPractices }} |
            | SEO | ${{ fromJson(steps.lighthouse-score.outputs.scores).seo }} |

            [View Full Report](${{ needs.build-preview.outputs.preview-url }})

  preview-success:
    name: Preview Success
    runs-on: ubuntu-latest
    needs: [build-preview, comment-preview]
    if: always()
    steps:
      - name: Check preview status
        run: |
          if [[ "${{ needs.build-preview.result }}" != "success" ]]; then
            echo "Preview deployment failed"
            exit 1
          fi
          echo "Preview deployment successful: ${{ needs.build-preview.outputs.preview-url }}"
